--- a/net/minecraft/server/network/MemoryServerHandshakePacketListenerImpl.java
+++ b/net/minecraft/server/network/MemoryServerHandshakePacketListenerImpl.java
@@ -5,34 +_,31 @@
 import net.minecraft.network.protocol.handshake.ClientIntent;
 import net.minecraft.network.protocol.handshake.ClientIntentionPacket;
 import net.minecraft.network.protocol.handshake.ServerHandshakePacketListener;
-import net.minecraft.network.protocol.login.LoginProtocols;
 import net.minecraft.server.MinecraftServer;
 
 public class MemoryServerHandshakePacketListenerImpl implements ServerHandshakePacketListener {
-    private final MinecraftServer server;
-    private final Connection connection;
-
-    public MemoryServerHandshakePacketListenerImpl(MinecraftServer p_9691_, Connection p_9692_) {
-        this.server = p_9691_;
-        this.connection = p_9692_;
-    }
-
-    @Override
-    public void handleIntention(ClientIntentionPacket p_9697_) {
-        if (p_9697_.intention() != ClientIntent.LOGIN) {
-            throw new UnsupportedOperationException("Invalid intention " + p_9697_.intention());
-        } else {
-            this.connection.setupInboundProtocol(LoginProtocols.SERVERBOUND, new ServerLoginPacketListenerImpl(this.server, this.connection, false));
-            this.connection.setupOutboundProtocol(LoginProtocols.CLIENTBOUND);
-        }
-    }
-
-    @Override
-    public void onDisconnect(Component p_9695_) {
-    }
-
-    @Override
-    public boolean isAcceptingMessages() {
-        return this.connection.isConnected();
-    }
+   private final MinecraftServer server;
+   private final Connection connection;
+
+   public MemoryServerHandshakePacketListenerImpl(MinecraftServer p_9691_, Connection p_9692_) {
+      this.server = p_9691_;
+      this.connection = p_9692_;
+   }
+
+   public void handleIntention(ClientIntentionPacket p_9697_) {
+      if (!net.minecraftforge.server.ServerLifecycleHooks.handleServerLogin(p_9697_, this.connection)) return;
+      if (p_9697_.intention() != ClientIntent.LOGIN) {
+         throw new UnsupportedOperationException("Invalid intention " + p_9697_.intention());
+      } else {
+         this.connection.setClientboundProtocolAfterHandshake(ClientIntent.LOGIN);
+         this.connection.setListener(new ServerLoginPacketListenerImpl(this.server, this.connection));
+      }
+   }
+
+   public void onDisconnect(Component p_9695_) {
+   }
+
+   public boolean isAcceptingMessages() {
+      return this.connection.isConnected();
+   }
 }
