--- a/net/minecraft/server/management/PlayerList.java
+++ b/net/minecraft/server/management/PlayerList.java
@@ -8,11 +8,14 @@
 import java.io.File;
 import java.net.SocketAddress;
 import java.text.SimpleDateFormat;
+import java.util.Arrays;
 import java.util.List;
 import java.util.Map;
 import java.util.Optional;
 import java.util.Set;
 import java.util.UUID;
+import java.util.concurrent.CopyOnWriteArrayList;
+import java.util.stream.Collectors;
 import javax.annotation.Nullable;
 import net.minecraft.advancements.PlayerAdvancements;
 import net.minecraft.entity.Entity;
@@ -23,16 +26,19 @@
 import net.minecraft.network.IPacket;
 import net.minecraft.network.NetworkManager;
 import net.minecraft.network.PacketBuffer;
+import net.minecraft.network.login.ServerLoginNetHandler;
 import net.minecraft.network.play.ServerPlayNetHandler;
 import net.minecraft.network.play.server.SChangeGameStatePacket;
 import net.minecraft.network.play.server.SChatPacket;
 import net.minecraft.network.play.server.SCustomPayloadPlayPacket;
+import net.minecraft.network.play.server.SEntityMetadataPacket;
 import net.minecraft.network.play.server.SEntityStatusPacket;
 import net.minecraft.network.play.server.SHeldItemChangePacket;
 import net.minecraft.network.play.server.SJoinGamePacket;
 import net.minecraft.network.play.server.SPlayEntityEffectPacket;
 import net.minecraft.network.play.server.SPlayerAbilitiesPacket;
 import net.minecraft.network.play.server.SPlayerListItemPacket;
+import net.minecraft.network.play.server.SPlayerListItemPacket.Action;
 import net.minecraft.network.play.server.SRespawnPacket;
 import net.minecraft.network.play.server.SServerDifficultyPacket;
 import net.minecraft.network.play.server.SSetExperiencePacket;
@@ -49,6 +55,7 @@
 import net.minecraft.scoreboard.ServerScoreboard;
 import net.minecraft.scoreboard.Team;
 import net.minecraft.server.MinecraftServer;
+import net.minecraft.server.dedicated.DedicatedServer;
 import net.minecraft.stats.ServerStatisticsManager;
 import net.minecraft.stats.Stats;
 import net.minecraft.util.math.BlockPos;
@@ -70,8 +77,25 @@
 import net.minecraftforge.api.distmarker.OnlyIn;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.Bukkit;
+import org.bukkit.Location;
+import org.bukkit.World;
+import org.bukkit.craftbukkit.v1_15_R1.CraftServer;
+import org.bukkit.craftbukkit.v1_15_R1.CraftWorld;
+import org.bukkit.craftbukkit.v1_15_R1.command.ColouredConsoleSender;
+import org.bukkit.craftbukkit.v1_15_R1.command.ConsoleCommandCompleter;
+import org.bukkit.craftbukkit.v1_15_R1.util.CraftChatMessage;
+import org.bukkit.entity.Player;
+import org.bukkit.event.player.PlayerChangedWorldEvent;
+import org.bukkit.event.player.PlayerJoinEvent;
+import org.bukkit.event.player.PlayerLoginEvent;
+import org.bukkit.event.player.PlayerLoginEvent.Result;
+import org.bukkit.event.player.PlayerQuitEvent;
+import org.bukkit.event.player.PlayerRespawnEvent;
+import org.spigotmc.event.player.PlayerSpawnLocationEvent;
 
 public abstract class PlayerList {
+
    public static final File field_152613_a = new File("banned-players.json");
    public static final File field_152614_b = new File("banned-ips.json");
    public static final File field_152615_c = new File("ops.json");
@@ -79,23 +103,35 @@
    private static final Logger field_148546_d = LogManager.getLogger();
    private static final SimpleDateFormat field_72403_e = new SimpleDateFormat("yyyy-MM-dd 'at' HH:mm:ss z");
    private final MinecraftServer field_72400_f;
-   private final List<ServerPlayerEntity> field_72404_b = Lists.newArrayList();
+   public final List<ServerPlayerEntity> field_72404_b = new CopyOnWriteArrayList<>(); // private->public CraftBukkit  // CraftBukkit - ArrayList -> CopyOnWriteArrayList: Iterator safety
    private final Map<UUID, ServerPlayerEntity> field_177454_f = Maps.newHashMap();
    private final BanList field_72401_g = new BanList(field_152613_a);
    private final IPBanList field_72413_h = new IPBanList(field_152614_b);
    private final OpList field_72414_i = new OpList(field_152615_c);
    private final WhiteList field_72411_j = new WhiteList(field_152616_d);
-   private final Map<UUID, ServerStatisticsManager> field_148547_k = Maps.newHashMap();
-   private final Map<UUID, PlayerAdvancements> field_192055_p = Maps.newHashMap();
-   private IPlayerFileData field_72412_k;
+   // CraftBukkit start
+   // private final Map<UUID, ServerStatisticsManager> playerStatFiles = Maps.newHashMap();
+   // private final Map<UUID, PlayerAdvancements> advancements = Maps.newHashMap();
+   // CraftBukkit end
+   public IPlayerFileData field_72412_k; // private->public CraftBukkit
    private boolean field_72409_l;
    protected final int field_72405_c;
    private int field_72402_d;
    private GameType field_72410_m;
    private boolean field_72407_n;
    private int field_72408_o;
+   private final List<ServerPlayerEntity> playersView = java.util.Collections.unmodifiableList(field_72404_b);
 
+   // CraftBukkit start
+   private CraftServer craftServer;
+   private final Map<String,ServerPlayerEntity> playersByName = new java.util.HashMap<>(); // Spigot
+
    public PlayerList(MinecraftServer p_i50688_1_, int p_i50688_2_) {
+      this.craftServer = p_i50688_1_.server = new CraftServer((DedicatedServer) p_i50688_1_, this);
+      p_i50688_1_.console = ColouredConsoleSender.getInstance();
+      p_i50688_1_.reader.addCompleter(new ConsoleCommandCompleter(p_i50688_1_.server));
+      // CraftBukkit end
+
       this.field_72400_f = p_i50688_1_;
       this.field_72405_c = p_i50688_2_;
       this.func_152608_h().func_152686_a(true);
@@ -109,22 +145,56 @@
       String s = gameprofile1 == null ? gameprofile.getName() : gameprofile1.getName();
       playerprofilecache.func_152649_a(gameprofile);
       CompoundNBT compoundnbt = this.func_72380_a(p_72355_2_);
-      ServerWorld serverworld = this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK);
+
+      //Forge: Make sure the dimension hasn't been deleted, if so stick them in the overworld.
+      ServerWorld serverworld = p_72355_2_.field_71093_bK != null ? this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK) : null;
+
+      // CraftBukkit start - Better rename detection
+      if (compoundnbt != null && compoundnbt.func_74764_b("bukkit")) {
+         CompoundNBT bukkit = compoundnbt.func_74775_l("bukkit");
+         s = bukkit.func_150297_b("lastKnownName", 8) ? bukkit.func_74779_i("lastKnownName") : s;
+      }
+      // CraftBukkit end
+
+      if (serverworld == null) {
+         p_72355_2_.field_71093_bK = DimensionType.field_223227_a_;
+         serverworld = this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK);
+         p_72355_2_.func_70107_b(serverworld.func_72912_H().func_76079_c(), serverworld.func_72912_H().func_76075_d(), serverworld.func_72912_H().func_76074_e());
+      }
+
       p_72355_2_.func_70029_a(serverworld);
-      p_72355_2_.field_71134_c.func_73080_a((ServerWorld)p_72355_2_.field_70170_p);
+      p_72355_2_.field_71134_c.func_73080_a((ServerWorld) p_72355_2_.field_70170_p);
       String s1 = "local";
       if (p_72355_1_.func_74430_c() != null) {
          s1 = p_72355_1_.func_74430_c().toString();
       }
 
-      field_148546_d.info("{}[{}] logged in with entity id {} at ({}, {}, {})", p_72355_2_.func_200200_C_().getString(), s1, p_72355_2_.func_145782_y(), p_72355_2_.func_226277_ct_(), p_72355_2_.func_226278_cu_(), p_72355_2_.func_226281_cx_());
+      // Spigot start - spawn location event
+      Player bukkitPlayer = p_72355_2_.getBukkitEntity();
+      PlayerSpawnLocationEvent ev = new PlayerSpawnLocationEvent(bukkitPlayer, bukkitPlayer.getLocation());
+      Bukkit.getPluginManager().callEvent(ev);
+      Location loc = ev.getSpawnLocation();
+      serverworld = ((CraftWorld) loc.getWorld()).getHandle();
+      p_72355_2_.func_70029_a(serverworld);
+      p_72355_2_.func_70080_a(loc.getX(), loc.getY(), loc.getZ(), loc.getYaw(), loc.getPitch());
+      // Spigot end
+
+      // CraftBukkit - Moved message to after join
+      //LOGGER.info("{}[{}] logged in with entity id {} at ({}, {}, {})", playerIn.getName().getString(), s1, playerIn.getEntityId(), playerIn.getPosX(), playerIn.getPosY(), playerIn.getPosZ());
       WorldInfo worldinfo = serverworld.func_72912_H();
-      this.func_72381_a(p_72355_2_, (ServerPlayerEntity)null, serverworld);
+      this.func_72381_a(p_72355_2_, (ServerPlayerEntity) null, serverworld);
       ServerPlayNetHandler serverplaynethandler = new ServerPlayNetHandler(this.field_72400_f, p_72355_1_, p_72355_2_);
+      net.minecraftforge.fml.network.NetworkHooks.sendMCRegistryPackets(p_72355_1_, "PLAY_TO_CLIENT");
+      net.minecraftforge.fml.network.NetworkHooks.sendDimensionDataPacket(p_72355_1_, p_72355_2_);
       GameRules gamerules = serverworld.func_82736_K();
       boolean flag = gamerules.func_223586_b(GameRules.field_226683_z_);
       boolean flag1 = gamerules.func_223586_b(GameRules.field_223612_o);
-      serverplaynethandler.func_147359_a(new SJoinGamePacket(p_72355_2_.func_145782_y(), p_72355_2_.field_71134_c.func_73081_b(), WorldInfo.func_227498_c_(worldinfo.func_76063_b()), worldinfo.func_76093_s(), serverworld.field_73011_w.func_186058_p(), this.func_72352_l(), worldinfo.func_76067_t(), this.field_72402_d, flag1, !flag));
+      // CraftBukkit - getType()
+      // Spigot - view distance
+      serverplaynethandler.func_147359_a(
+          new SJoinGamePacket(p_72355_2_.func_145782_y(), p_72355_2_.field_71134_c.func_73081_b(), WorldInfo.func_227498_c_(worldinfo.func_76063_b()), worldinfo.func_76093_s(), serverworld.field_73011_w.func_186058_p(),
+              this.func_72352_l(), worldinfo.func_76067_t(), serverworld.spigotConfig.viewDistance, flag1, !flag));
+      p_72355_2_.getBukkitEntity().sendSupportedChannels(); // CraftBukkit
       serverplaynethandler.func_147359_a(new SCustomPayloadPlayPacket(SCustomPayloadPlayPacket.field_209911_b, (new PacketBuffer(Unpooled.buffer())).func_180714_a(this.func_72365_p().getServerModName())));
       serverplaynethandler.func_147359_a(new SServerDifficultyPacket(worldinfo.func_176130_y(), worldinfo.func_176123_z()));
       serverplaynethandler.func_147359_a(new SPlayerAbilitiesPacket(p_72355_2_.field_71075_bZ));
@@ -143,38 +213,78 @@
          itextcomponent = new TranslationTextComponent("multiplayer.player.joined.renamed", p_72355_2_.func_145748_c_(), s);
       }
 
-      this.func_148539_a(itextcomponent.func_211708_a(TextFormatting.YELLOW));
+      // CraftBukkit start
+      itextcomponent.func_211708_a(TextFormatting.YELLOW);
+      String joinMessage = CraftChatMessage.fromComponent(itextcomponent);
+
       serverplaynethandler.func_147364_a(p_72355_2_.func_226277_ct_(), p_72355_2_.func_226278_cu_(), p_72355_2_.func_226281_cx_(), p_72355_2_.field_70177_z, p_72355_2_.field_70125_A);
-      this.field_72404_b.add(p_72355_2_);
+      this.addPlayer(p_72355_2_);
       this.field_177454_f.put(p_72355_2_.func_110124_au(), p_72355_2_);
-      this.func_148540_a(new SPlayerListItemPacket(SPlayerListItemPacket.Action.ADD_PLAYER, p_72355_2_));
+      //this.sendPacketToAllPlayers(new SPlayerListItemPacket(SPlayerListItemPacket.Action.ADD_PLAYER, playerIn)); // CraftBukkit - replaced with loop below
 
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      // CraftBukkit start
+      PlayerJoinEvent playerJoinEvent = new PlayerJoinEvent(craftServer.getPlayer(p_72355_2_), joinMessage);
+      craftServer.getPluginManager().callEvent(playerJoinEvent);
+      if (!p_72355_2_.field_71135_a.field_147371_a.func_150724_d()) {
+         return;
+      }
+      joinMessage = playerJoinEvent.getJoinMessage();
+      if (joinMessage != null && joinMessage.length() > 0) {
+         for (ITextComponent line : org.bukkit.craftbukkit.v1_15_R1.util.CraftChatMessage.fromString(joinMessage)) {
+            field_72400_f.func_184103_al().func_148540_a(new SChatPacket(line));
+         }
+      }
+      // CraftBukkit end
+
+      // CraftBukkit start - sendAll above replaced with this loop
+      SPlayerListItemPacket packet = new SPlayerListItemPacket(Action.ADD_PLAYER, new ServerPlayerEntity[] { p_72355_2_ });
+
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          p_72355_2_.field_71135_a.func_147359_a(new SPlayerListItemPacket(SPlayerListItemPacket.Action.ADD_PLAYER, this.field_72404_b.get(i)));
+         ServerPlayerEntity entityplayer1 = (ServerPlayerEntity) this.field_72404_b.get(i);
+         if (entityplayer1.getBukkitEntity().canSee(p_72355_2_.getBukkitEntity())) {
+            entityplayer1.field_71135_a.func_147359_a(packet);
+         }
+         if (!p_72355_2_.getBukkitEntity().canSee(entityplayer1.getBukkitEntity())) {
+            continue;
+         }
+         p_72355_2_.field_71135_a.func_147359_a(new SPlayerListItemPacket(Action.ADD_PLAYER, entityplayer1));
       }
+      p_72355_2_.sentListPacket = true;
+      // CraftBukkit end
+      p_72355_2_.field_71135_a.func_147359_a(new SEntityMetadataPacket(p_72355_2_.func_145782_y(), p_72355_2_.func_184212_Q(), true)); // CraftBukkit - BungeeCord#2321, send complete data to self on spawn
+      // CraftBukkit start - Only add if the player wasn't moved in the event
+      if (p_72355_2_.field_70170_p == serverworld && !serverworld.func_217369_A().contains(p_72355_2_)) {
+         serverworld.func_217435_c(p_72355_2_);
+         this.field_72400_f.func_201300_aS().func_201383_a(p_72355_2_);
+      }
 
-      serverworld.func_217435_c(p_72355_2_);
-      this.field_72400_f.func_201300_aS().func_201383_a(p_72355_2_);
+      serverworld = this.field_72400_f.func_71218_a(p_72355_2_.field_71093_bK); // CraftBukkit - Update in case join event changed it
+      // CraftBukkit end
+
       this.func_72354_b(p_72355_2_, serverworld);
       if (!this.field_72400_f.func_147133_T().isEmpty()) {
          p_72355_2_.func_175397_a(this.field_72400_f.func_147133_T(), this.field_72400_f.func_175581_ab());
       }
 
-      for(EffectInstance effectinstance : p_72355_2_.func_70651_bq()) {
+      for (EffectInstance effectinstance : p_72355_2_.func_70651_bq()) {
          serverplaynethandler.func_147359_a(new SPlayEntityEffectPacket(p_72355_2_.func_145782_y(), effectinstance));
       }
 
       if (compoundnbt != null && compoundnbt.func_150297_b("RootVehicle", 10)) {
          CompoundNBT compoundnbt1 = compoundnbt.func_74775_l("RootVehicle");
+         // CraftBukkit start
+         final ServerWorld worldf = serverworld;
          Entity entity1 = EntityType.func_220335_a(compoundnbt1.func_74775_l("Entity"), serverworld, (p_217885_1_) -> {
-            return !serverworld.func_217470_d(p_217885_1_) ? null : p_217885_1_;
+            return !worldf.func_217470_d(p_217885_1_) ? null : p_217885_1_;
+            // CraftBukkit end
          });
          if (entity1 != null) {
             UUID uuid = compoundnbt1.func_186857_a("Attach");
             if (entity1.func_110124_au().equals(uuid)) {
                p_72355_2_.func_184205_a(entity1, true);
             } else {
-               for(Entity entity : entity1.func_184182_bu()) {
+               for (Entity entity : entity1.func_184182_bu()) {
                   if (entity.func_110124_au().equals(uuid)) {
                      p_72355_2_.func_184205_a(entity, true);
                      break;
@@ -186,7 +296,7 @@
                field_148546_d.warn("Couldn't reattach entity to player");
                serverworld.func_217467_h(entity1);
 
-               for(Entity entity2 : entity1.func_184182_bu()) {
+               for (Entity entity2 : entity1.func_184182_bu()) {
                   serverworld.func_217467_h(entity2);
                }
             }
@@ -194,19 +304,23 @@
       }
 
       p_72355_2_.func_71116_b();
+      net.minecraftforge.fml.hooks.BasicEventHooks.firePlayerLoggedIn(p_72355_2_);
+      // CraftBukkit - Moved from above, added world
+      field_148546_d.info("{}[{}] logged in with entity id {} at ([{}]{}, {}, {})", p_72355_2_.func_200200_C_().getString(), s1, p_72355_2_.func_145782_y(), p_72355_2_.field_70170_p.field_72986_A.func_76065_j(), p_72355_2_.func_226277_ct_(),
+          p_72355_2_.func_226278_cu_(), p_72355_2_.func_226281_cx_());
    }
 
-   protected void func_96456_a(ServerScoreboard p_96456_1_, ServerPlayerEntity p_96456_2_) {
+   public void func_96456_a(ServerScoreboard p_96456_1_, ServerPlayerEntity p_96456_2_) {
       Set<ScoreObjective> set = Sets.newHashSet();
 
-      for(ScorePlayerTeam scoreplayerteam : p_96456_1_.func_96525_g()) {
+      for (ScorePlayerTeam scoreplayerteam : p_96456_1_.func_96525_g()) {
          p_96456_2_.field_71135_a.func_147359_a(new STeamsPacket(scoreplayerteam, 0));
       }
 
-      for(int i = 0; i < 19; ++i) {
+      for (int i = 0; i < 19; ++i) {
          ScoreObjective scoreobjective = p_96456_1_.func_96539_a(i);
          if (scoreobjective != null && !set.contains(scoreobjective)) {
-            for(IPacket<?> ipacket : p_96456_1_.func_96550_d(scoreobjective)) {
+            for (IPacket<?> ipacket : p_96456_1_.func_96550_d(scoreobjective)) {
                p_96456_2_.field_71135_a.func_147359_a(ipacket);
             }
 
@@ -217,26 +331,28 @@
    }
 
    public void func_212504_a(ServerWorld p_212504_1_) {
+      if (field_72412_k != null)
+         return; // CraftBukkit
       this.field_72412_k = p_212504_1_.func_217485_w();
       p_212504_1_.func_175723_af().func_177737_a(new IBorderListener() {
          public void func_177694_a(WorldBorder p_177694_1_, double p_177694_2_) {
-            PlayerList.this.func_148540_a(new SWorldBorderPacket(p_177694_1_, SWorldBorderPacket.Action.SET_SIZE));
+            PlayerList.this.sendAll(new SWorldBorderPacket(p_177694_1_, SWorldBorderPacket.Action.SET_SIZE), p_177694_1_.world); // CraftBukkit
          }
 
          public void func_177692_a(WorldBorder p_177692_1_, double p_177692_2_, double p_177692_4_, long p_177692_6_) {
-            PlayerList.this.func_148540_a(new SWorldBorderPacket(p_177692_1_, SWorldBorderPacket.Action.LERP_SIZE));
+            PlayerList.this.sendAll(new SWorldBorderPacket(p_177692_1_, SWorldBorderPacket.Action.LERP_SIZE), p_177692_1_.world); // CraftBukkit
          }
 
          public void func_177693_a(WorldBorder p_177693_1_, double p_177693_2_, double p_177693_4_) {
-            PlayerList.this.func_148540_a(new SWorldBorderPacket(p_177693_1_, SWorldBorderPacket.Action.SET_CENTER));
+            PlayerList.this.sendAll(new SWorldBorderPacket(p_177693_1_, SWorldBorderPacket.Action.SET_CENTER), p_177693_1_.world); // CraftBukkit
          }
 
          public void func_177691_a(WorldBorder p_177691_1_, int p_177691_2_) {
-            PlayerList.this.func_148540_a(new SWorldBorderPacket(p_177691_1_, SWorldBorderPacket.Action.SET_WARNING_TIME));
+            PlayerList.this.sendAll(new SWorldBorderPacket(p_177691_1_, SWorldBorderPacket.Action.SET_WARNING_TIME), p_177691_1_.world); // CraftBukkit
          }
 
          public void func_177690_b(WorldBorder p_177690_1_, int p_177690_2_) {
-            PlayerList.this.func_148540_a(new SWorldBorderPacket(p_177690_1_, SWorldBorderPacket.Action.SET_WARNING_BLOCKS));
+            PlayerList.this.sendAll(new SWorldBorderPacket(p_177690_1_, SWorldBorderPacket.Action.SET_WARNING_BLOCKS), p_177690_1_.world); // CraftBukkit
          }
 
          public void func_177696_b(WorldBorder p_177696_1_, double p_177696_2_) {
@@ -255,6 +371,7 @@
          compoundnbt1 = compoundnbt;
          p_72380_1_.func_70020_e(compoundnbt);
          field_148546_d.debug("loading single player");
+         net.minecraftforge.event.ForgeEventFactory.firePlayerLoadingEvent(p_72380_1_, this.field_72412_k, p_72380_1_.func_110124_au().toString());
       } else {
          compoundnbt1 = this.field_72412_k.func_75752_b(p_72380_1_);
       }
@@ -263,164 +380,281 @@
    }
 
    protected void func_72391_b(ServerPlayerEntity p_72391_1_) {
+      if (!p_72391_1_.getBukkitEntity().isPersistent())
+         return; // CraftBukkit
+      if (p_72391_1_.field_71135_a == null)
+         return;
       this.field_72412_k.func_75753_a(p_72391_1_);
-      ServerStatisticsManager serverstatisticsmanager = this.field_148547_k.get(p_72391_1_.func_110124_au());
+      ServerStatisticsManager serverstatisticsmanager = p_72391_1_.func_147099_x(); // CraftBukkit
       if (serverstatisticsmanager != null) {
          serverstatisticsmanager.func_150883_b();
       }
 
-      PlayerAdvancements playeradvancements = this.field_192055_p.get(p_72391_1_.func_110124_au());
+      PlayerAdvancements playeradvancements = p_72391_1_.func_192039_O(); // CraftBukkit
       if (playeradvancements != null) {
          playeradvancements.func_192749_b();
       }
 
    }
 
-   public void func_72367_e(ServerPlayerEntity p_72367_1_) {
-      ServerWorld serverworld = p_72367_1_.func_71121_q();
-      p_72367_1_.func_195066_a(Stats.field_75947_j);
-      this.func_72391_b(p_72367_1_);
-      if (p_72367_1_.func_184218_aH()) {
-         Entity entity = p_72367_1_.func_184208_bv();
+   public String playerLoggedOut(ServerPlayerEntity playerIn) { // CraftBukkit void->string
+      net.minecraftforge.fml.hooks.BasicEventHooks.firePlayerLoggedOut(playerIn);
+      ServerWorld serverworld = playerIn.func_71121_q();
+      playerIn.func_195066_a(Stats.field_75947_j);
+
+      // CraftBukkit start - Quitting must be before we do final save of data, in case plugins need to modify it
+      org.bukkit.craftbukkit.v1_15_R1.event.CraftEventFactory.handleInventoryCloseEvent(playerIn);
+      PlayerQuitEvent playerQuitEvent = new PlayerQuitEvent(craftServer.getPlayer(playerIn), "\u00A7e" + playerIn.func_200200_C_() + " left the game");
+      craftServer.getPluginManager().callEvent(playerQuitEvent);
+      playerIn.getBukkitEntity().disconnect(playerQuitEvent.getQuitMessage());
+      playerIn.func_71127_g();// SPIGOT-924
+      // CraftBukkit end
+
+      this.func_72391_b(playerIn);
+      if (playerIn.func_184218_aH()) {
+         Entity entity = playerIn.func_184208_bv();
          if (entity.func_200601_bK()) {
             field_148546_d.debug("Removing player mount");
-            p_72367_1_.func_184210_p();
+            playerIn.func_184210_p();
             serverworld.func_217467_h(entity);
 
-            for(Entity entity1 : entity.func_184182_bu()) {
+            for (Entity entity1 : entity.func_184182_bu()) {
                serverworld.func_217467_h(entity1);
             }
 
-            serverworld.func_212866_a_(p_72367_1_.field_70176_ah, p_72367_1_.field_70164_aj).func_76630_e();
+            serverworld.func_212866_a_(playerIn.field_70176_ah, playerIn.field_70164_aj).func_76630_e();
          }
       }
 
-      p_72367_1_.func_213319_R();
-      serverworld.func_217434_e(p_72367_1_);
-      p_72367_1_.func_192039_O().func_192745_a();
-      this.field_72404_b.remove(p_72367_1_);
-      this.field_72400_f.func_201300_aS().func_201382_b(p_72367_1_);
-      UUID uuid = p_72367_1_.func_110124_au();
+      playerIn.func_213319_R();
+      serverworld.func_217434_e(playerIn);
+      playerIn.func_192039_O().func_192745_a();
+      this.removePlayer(playerIn);
+      this.field_72400_f.func_201300_aS().func_201382_b(playerIn);
+      UUID uuid = playerIn.func_110124_au();
       ServerPlayerEntity serverplayerentity = this.field_177454_f.get(uuid);
-      if (serverplayerentity == p_72367_1_) {
+      if (serverplayerentity == playerIn) {
          this.field_177454_f.remove(uuid);
-         this.field_148547_k.remove(uuid);
-         this.field_192055_p.remove(uuid);
+         // CraftBukkit start
+         // this.playerStatFiles.remove(uuid);
+         // this.advancements.remove(uuid);
+         // CraftBukkit end
       }
 
-      this.func_148540_a(new SPlayerListItemPacket(SPlayerListItemPacket.Action.REMOVE_PLAYER, p_72367_1_));
+      // CraftBukkit start
+      SPlayerListItemPacket packet = new SPlayerListItemPacket(Action.REMOVE_PLAYER, new ServerPlayerEntity[] { playerIn });
+      for (int i = 0; i < field_72404_b.size(); ++i) {
+         ServerPlayerEntity entityplayer2 = (ServerPlayerEntity) this.field_72404_b.get(i);
+         if (entityplayer2.getBukkitEntity().canSee(playerIn.getBukkitEntity())) {
+            entityplayer2.field_71135_a.func_147359_a(packet);
+         } else {
+            entityplayer2.getBukkitEntity().removeDisconnectingPlayer(playerIn.getBukkitEntity());
+         }
+      }
+      // This removes the scoreboard (and player reference) for the specific player in the manager
+      craftServer.getScoreboardManager().removePlayer(playerIn.getBukkitEntity());
+      // CraftBukkit end
+
+      return playerQuitEvent.getQuitMessage(); // CraftBukkit
    }
 
-   @Nullable
-   public ITextComponent func_206258_a(SocketAddress p_206258_1_, GameProfile p_206258_2_) {
-      if (this.field_72401_g.func_152702_a(p_206258_2_)) {
-         ProfileBanEntry profilebanentry = this.field_72401_g.func_152683_b(p_206258_2_);
+   // CraftBukkit start - Whole method, SocketAddress to LoginListener, added hostname to signature, return EntityPlayer
+   public ServerPlayerEntity canPlayerLogin(ServerLoginNetHandler netHandler, GameProfile gameProfile, String hostName) {
+      // Moved from processLogin
+      UUID uuid = PlayerEntity.func_146094_a(gameProfile);
+      List<ServerPlayerEntity> playerEntityList = Lists.newArrayList();
+      ServerPlayerEntity entityPlayer;
+      for (ServerPlayerEntity player : this.field_72404_b) {
+         entityPlayer = player;
+         if (entityPlayer.func_110124_au().equals(uuid)) {
+            playerEntityList.add(entityPlayer);
+         }
+      }
+      for (ServerPlayerEntity serverPlayerEntity : playerEntityList) {
+         entityPlayer = serverPlayerEntity;
+         this.func_72391_b(entityPlayer); // CraftBukkit - Force the player's inventory to be saved
+         entityPlayer.field_71135_a.func_194028_b(new TranslationTextComponent("multiplayer.disconnect.duplicate_login"));
+      }
+
+      // Instead of kicking then returning, we need to store the kick reason
+      // in the event, check with plugins to see if it's ok, and THEN kick
+      // depending on the outcome.
+      SocketAddress socketAddress = netHandler.field_147333_a.func_74430_c();
+
+      ServerPlayerEntity entity = new ServerPlayerEntity(this.field_72400_f, this.field_72400_f.func_71218_a(DimensionType.field_223227_a_), gameProfile,
+          new PlayerInteractionManager(this.field_72400_f.func_71218_a(DimensionType.field_223227_a_)));
+      Player player = entity.getBukkitEntity();
+      PlayerLoginEvent event = new PlayerLoginEvent(player, hostName, ((java.net.InetSocketAddress) socketAddress).getAddress(), ((java.net.InetSocketAddress) netHandler.field_147333_a.getRawAddress()).getAddress());
+
+      if (this.func_152608_h().func_152702_a(gameProfile) && !this.func_152608_h().func_152683_b(gameProfile).func_73682_e()) {
+         ProfileBanEntry profilebanentry = this.field_72401_g.func_152683_b(gameProfile);
          ITextComponent itextcomponent1 = new TranslationTextComponent("multiplayer.disconnect.banned.reason", profilebanentry.func_73686_f());
          if (profilebanentry.func_73680_d() != null) {
             itextcomponent1.func_150257_a(new TranslationTextComponent("multiplayer.disconnect.banned.expiration", field_72403_e.format(profilebanentry.func_73680_d())));
          }
 
-         return itextcomponent1;
-      } else if (!this.func_152607_e(p_206258_2_)) {
-         return new TranslationTextComponent("multiplayer.disconnect.not_whitelisted");
-      } else if (this.field_72413_h.func_152708_a(p_206258_1_)) {
-         IPBanEntry ipbanentry = this.field_72413_h.func_152709_b(p_206258_1_);
+         if(!profilebanentry.func_73682_e()) event.disallow(Result.KICK_BANNED, CraftChatMessage.fromComponent(itextcomponent1)); // CraftBukkit // Spigot
+      } else if (!this.func_152607_e(gameProfile)) {
+         TranslationTextComponent chatMessage = new TranslationTextComponent("multiplayer.disconnect.not_whitelisted");
+         event.disallow(Result.KICK_WHITELIST, org.spigotmc.SpigotConfig.whitelistMessage); // Spigot
+      } else if (this.func_72363_f().func_152708_a(socketAddress) && !this.func_72363_f().func_152709_b(socketAddress).func_73682_e()) {
+         IPBanEntry ipbanentry = this.field_72413_h.func_152709_b(socketAddress);
          ITextComponent itextcomponent = new TranslationTextComponent("multiplayer.disconnect.banned_ip.reason", ipbanentry.func_73686_f());
          if (ipbanentry.func_73680_d() != null) {
             itextcomponent.func_150257_a(new TranslationTextComponent("multiplayer.disconnect.banned_ip.expiration", field_72403_e.format(ipbanentry.func_73680_d())));
          }
 
-         return itextcomponent;
-      } else {
-         return this.field_72404_b.size() >= this.field_72405_c && !this.func_183023_f(p_206258_2_) ? new TranslationTextComponent("multiplayer.disconnect.server_full") : null;
+         event.disallow(Result.KICK_BANNED, CraftChatMessage.fromComponent(itextcomponent));
+      } else if (this.field_72404_b.size() >= this.field_72405_c && !this.func_183023_f(gameProfile)) {
+         event.disallow(PlayerLoginEvent.Result.KICK_FULL, org.spigotmc.SpigotConfig.serverFullMessage); // Spigot
       }
+      this.craftServer.getPluginManager().callEvent(event);
+      if (event.getResult() != Result.ALLOWED) {
+         netHandler.disconnect(event.getKickMessage());
+         return null;
+      }
+
+      return entity;
    }
 
-   public ServerPlayerEntity func_148545_a(GameProfile p_148545_1_) {
-      UUID uuid = PlayerEntity.func_146094_a(p_148545_1_);
-      List<ServerPlayerEntity> list = Lists.newArrayList();
+   public ServerPlayerEntity createPlayerForUser(GameProfile profile, ServerPlayerEntity playerEntity) { // CraftBukkit - add ServerPlayerEntity
+      return playerEntity;
+   }
 
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
-         ServerPlayerEntity serverplayerentity = this.field_72404_b.get(i);
-         if (serverplayerentity.func_110124_au().equals(uuid)) {
-            list.add(serverplayerentity);
-         }
-      }
+   public ServerPlayerEntity func_72368_a(ServerPlayerEntity p_72368_1_, DimensionType p_72368_2_, boolean p_72368_3_) {
+      return this.moveToWorld(p_72368_1_, p_72368_2_, p_72368_3_, null, true);
+   }
 
-      ServerPlayerEntity serverplayerentity2 = this.field_177454_f.get(p_148545_1_.getId());
-      if (serverplayerentity2 != null && !list.contains(serverplayerentity2)) {
-         list.add(serverplayerentity2);
-      }
+   public ServerPlayerEntity moveToWorld(ServerPlayerEntity playerIn, DimensionType dimension, boolean conqueredEnd, Location location, boolean avoidSuffocation) {
+      playerIn.func_184210_p(); // CraftBukkit
+      ServerWorld world = field_72400_f.func_71218_a(dimension);
+      if (world == null)
+         dimension = playerIn.getSpawnDimension();
+      else if (!world.func_201675_m().func_76567_e())
+         dimension = world.func_201675_m().getRespawnDimension(playerIn);
+      if (field_72400_f.func_71218_a(dimension) == null)
+         dimension = DimensionType.field_223227_a_;
 
-      for(ServerPlayerEntity serverplayerentity1 : list) {
-         serverplayerentity1.field_71135_a.func_194028_b(new TranslationTextComponent("multiplayer.disconnect.duplicate_login"));
-      }
+      this.removePlayer(playerIn);
+      playerIn.func_71121_q().removePlayer(playerIn, true); // Forge: keep data until copyFrom called
+      BlockPos blockpos = playerIn.getBedLocation(dimension);
+      boolean flag = playerIn.isSpawnForced(dimension);
 
-      PlayerInteractionManager playerinteractionmanager;
-      if (this.field_72400_f.func_71242_L()) {
-         playerinteractionmanager = new DemoPlayerInteractionManager(this.field_72400_f.func_71218_a(DimensionType.field_223227_a_));
-      } else {
-         playerinteractionmanager = new PlayerInteractionManager(this.field_72400_f.func_71218_a(DimensionType.field_223227_a_));
-      }
+      ServerPlayerEntity serverPlayerEntity = playerIn;
+      World fromWorld = playerIn.getBukkitEntity().getWorld();
+      playerIn.field_71136_j = false;
+      // CraftBukkit end
 
-      return new ServerPlayerEntity(this.field_72400_f, this.field_72400_f.func_71218_a(DimensionType.field_223227_a_), p_148545_1_, playerinteractionmanager);
-   }
+      serverPlayerEntity.field_71135_a = playerIn.field_71135_a;
+      serverPlayerEntity.func_193104_a(playerIn, conqueredEnd);
+      playerIn.remove(false); // Forge: clone event had a chance to see old data, now discard it
+      serverPlayerEntity.field_71093_bK = dimension;
+      serverPlayerEntity.func_145769_d(playerIn.func_145782_y());
+      serverPlayerEntity.func_184819_a(playerIn.func_184591_cq());
 
-   public ServerPlayerEntity func_72368_a(ServerPlayerEntity p_72368_1_, DimensionType p_72368_2_, boolean p_72368_3_) {
-      this.field_72404_b.remove(p_72368_1_);
-      p_72368_1_.func_71121_q().func_217434_e(p_72368_1_);
-      BlockPos blockpos = p_72368_1_.func_180470_cg();
-      boolean flag = p_72368_1_.func_82245_bX();
-      p_72368_1_.field_71093_bK = p_72368_2_;
-      PlayerInteractionManager playerinteractionmanager;
-      if (this.field_72400_f.func_71242_L()) {
-         playerinteractionmanager = new DemoPlayerInteractionManager(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK));
-      } else {
-         playerinteractionmanager = new PlayerInteractionManager(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK));
+      for (String s : playerIn.func_184216_O()) {
+         serverPlayerEntity.func_184211_a(s);
       }
 
-      ServerPlayerEntity serverplayerentity = new ServerPlayerEntity(this.field_72400_f, this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK), p_72368_1_.func_146103_bH(), playerinteractionmanager);
-      serverplayerentity.field_71135_a = p_72368_1_.field_71135_a;
-      serverplayerentity.func_193104_a(p_72368_1_, p_72368_3_);
-      serverplayerentity.func_145769_d(p_72368_1_.func_145782_y());
-      serverplayerentity.func_184819_a(p_72368_1_.func_184591_cq());
+      // ServerWorld serverworld = this.server.getWorld(playerIn.dimension); // CraftBukkit - handled later
 
-      for(String s : p_72368_1_.func_184216_O()) {
-         serverplayerentity.func_184211_a(s);
-      }
-
-      ServerWorld serverworld = this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK);
-      this.func_72381_a(serverplayerentity, p_72368_1_, serverworld);
-      if (blockpos != null) {
-         Optional<Vec3d> optional = PlayerEntity.func_213822_a(this.field_72400_f.func_71218_a(p_72368_1_.field_71093_bK), blockpos, flag);
+      // CraftBukkit start - fire PlayerRespawnEvent
+      if (location == null) {
+         boolean isBedSpawn = false;
+         CraftWorld cworld = (CraftWorld)this.field_72400_f.server.getWorld(playerIn.spawnWorld);
+         if (cworld != null && blockpos != null) {
+            final Optional<Vec3d> optional = PlayerEntity.func_213822_a(cworld.getHandle(), blockpos, flag);
          if (optional.isPresent()) {
-            Vec3d vec3d = optional.get();
-            serverplayerentity.func_70012_b(vec3d.field_72450_a, vec3d.field_72448_b, vec3d.field_72449_c, 0.0F, 0.0F);
-            serverplayerentity.func_226560_a_(blockpos, flag, false);
-         } else {
-            serverplayerentity.field_71135_a.func_147359_a(new SChangeGameStatePacket(0, 0.0F));
+               final Vec3d vec3d = optional.get();
+               isBedSpawn = true;
+               location = new Location(cworld, vec3d.field_72450_a, vec3d.field_72448_b, vec3d.field_72449_c);
+            }
+            else {
+               serverPlayerEntity.func_226560_a_(null, true, false);
+               serverPlayerEntity.field_71135_a.func_147359_a(new SChangeGameStatePacket(0, 0.0f));
+            }
          }
+         if (location == null) {
+            cworld = (CraftWorld) this.field_72400_f.server.getWorlds().get(0);
+            blockpos = serverPlayerEntity.getSpawnPoint(cworld.getHandle());
+            location = new Location(cworld, blockpos.func_177958_n() + 0.5f, blockpos.func_177956_o() + 0.1f, blockpos.func_177952_p() + 0.5f);
+         }
+         Player respawnPlayer = this.craftServer.getPlayer(serverPlayerEntity);
+         PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn);
+         this.craftServer.getPluginManager().callEvent(respawnEvent);
+         // Spigot Start
+         if (playerIn.field_71135_a.isDisconnected()) {
+            return playerIn;
+         }
+         // Spigot End
+
+         location = respawnEvent.getRespawnLocation();
+         if (!flag) {
+            playerIn.reset(); // SPIGOT-4785
+         }
       }
+      else {
+         location.setWorld(this.field_72400_f.func_71218_a(dimension).getWorldCB());
+      }
+      ServerWorld worldserver = ((CraftWorld)location.getWorld()).getHandle();
+      serverPlayerEntity.forceSetPositionRotation(location.getX(), location.getY(), location.getZ(), location.getYaw(), location.getPitch());
+      // CraftBukkit end
 
-      while(!serverworld.func_226669_j_(serverplayerentity) && serverplayerentity.func_226278_cu_() < 256.0D) {
-         serverplayerentity.func_70107_b(serverplayerentity.func_226277_ct_(), serverplayerentity.func_226278_cu_() + 1.0D, serverplayerentity.func_226281_cx_());
+      while(avoidSuffocation && !worldserver.func_226669_j_(serverPlayerEntity) && serverPlayerEntity.func_226278_cu_() < 256.0) {
+         serverPlayerEntity.func_70107_b(serverPlayerEntity.func_226277_ct_(), serverPlayerEntity.func_226278_cu_() + 1.0D, serverPlayerEntity.func_226281_cx_());
       }
+      // CraftBukkit start
+      // Force the client to refresh their chunk cache
+      if (fromWorld.getEnvironment() == worldserver.getWorldCB().getEnvironment()) {
+         serverPlayerEntity.field_71135_a.func_147359_a(new SRespawnPacket((worldserver.field_73011_w.func_186058_p().func_186068_a() >= 0) ? DimensionType.field_223228_b_ : DimensionType.field_223227_a_, WorldInfo.func_227498_c_(worldserver.func_72912_H().func_76063_b()), worldserver.func_72912_H().func_76067_t(), playerIn.field_71134_c.func_73081_b()));
+      }
 
-      WorldInfo worldinfo = serverplayerentity.field_70170_p.func_72912_H();
-      serverplayerentity.field_71135_a.func_147359_a(new SRespawnPacket(serverplayerentity.field_71093_bK, WorldInfo.func_227498_c_(worldinfo.func_76063_b()), worldinfo.func_76067_t(), serverplayerentity.field_71134_c.func_73081_b()));
-      BlockPos blockpos1 = serverworld.func_175694_M();
-      serverplayerentity.field_71135_a.func_147364_a(serverplayerentity.func_226277_ct_(), serverplayerentity.func_226278_cu_(), serverplayerentity.func_226281_cx_(), serverplayerentity.field_70177_z, serverplayerentity.field_70125_A);
-      serverplayerentity.field_71135_a.func_147359_a(new SSpawnPositionPacket(blockpos1));
-      serverplayerentity.field_71135_a.func_147359_a(new SServerDifficultyPacket(worldinfo.func_176130_y(), worldinfo.func_176123_z()));
-      serverplayerentity.field_71135_a.func_147359_a(new SSetExperiencePacket(serverplayerentity.field_71106_cc, serverplayerentity.field_71067_cb, serverplayerentity.field_71068_ca));
-      this.func_72354_b(serverplayerentity, serverworld);
-      this.func_187243_f(serverplayerentity);
-      serverworld.func_217433_d(serverplayerentity);
-      this.field_72404_b.add(serverplayerentity);
-      this.field_177454_f.put(serverplayerentity.func_110124_au(), serverplayerentity);
-      serverplayerentity.func_71116_b();
-      serverplayerentity.func_70606_j(serverplayerentity.func_110143_aJ());
-      return serverplayerentity;
+      WorldInfo worldinfo = worldserver.func_72912_H();
+      net.minecraftforge.fml.network.NetworkHooks.sendDimensionDataPacket(serverPlayerEntity.field_71135_a.field_147371_a, serverPlayerEntity);
+      serverPlayerEntity.field_71135_a.func_147359_a(new SRespawnPacket(worldserver.field_73011_w.func_186058_p().getType(), WorldInfo.func_227498_c_(worldserver.func_72912_H().func_76063_b()), worldserver.func_72912_H().func_76067_t(), serverPlayerEntity.field_71134_c.func_73081_b()));
+      serverPlayerEntity.field_71135_a.func_147359_a(new SUpdateViewDistancePacket(worldserver.spigotConfig.viewDistance)); // Spigot
+      serverPlayerEntity.func_70029_a(worldserver);
+      serverPlayerEntity.field_70128_L = false;
+      serverPlayerEntity.field_71135_a.teleport(new Location(worldserver.getWorldCB(), serverPlayerEntity.func_226277_ct_(), serverPlayerEntity.func_226278_cu_(), serverPlayerEntity.func_226281_cx_(), serverPlayerEntity.field_70177_z, serverPlayerEntity.field_70125_A));
+      serverPlayerEntity.func_226284_e_(false);
+      BlockPos blockpos1 = worldserver.func_175694_M();
+      // serverPlayerEntity.connection.setPlayerLocation(serverPlayerEntity.getPosX(), serverPlayerEntity.getPosY(), serverPlayerEntity.getPosZ(), serverPlayerEntity.rotationYaw, serverPlayerEntity.rotationPitch);
+      serverPlayerEntity.field_71135_a.func_147359_a(new SSpawnPositionPacket(blockpos1));
+      serverPlayerEntity.field_71135_a.func_147359_a(new SServerDifficultyPacket(worldinfo.func_176130_y(), worldinfo.func_176123_z()));
+      serverPlayerEntity.field_71135_a.func_147359_a(new SSetExperiencePacket(serverPlayerEntity.field_71106_cc, serverPlayerEntity.field_71067_cb, serverPlayerEntity.field_71068_ca));
+      this.func_72354_b(serverPlayerEntity, worldserver);
+      this.func_187243_f(serverPlayerEntity);
+      if (!playerIn.field_71135_a.isDisconnected()) {
+         worldserver.func_217433_d(serverPlayerEntity);
+         this.field_72404_b.add(serverPlayerEntity);
+         this.playersByName.put(serverPlayerEntity.func_145748_c_().func_150254_d().toLowerCase(java.util.Locale.ROOT), serverPlayerEntity); // Spigot
+         this.field_177454_f.put(serverPlayerEntity.func_110124_au(), serverPlayerEntity);
+      }
+      // Update health, etc...
+      serverPlayerEntity.func_70606_j(serverPlayerEntity.func_110143_aJ());
+      this.func_72385_f(playerIn);
+      playerIn.func_71016_p();
+      for (Object o1 : playerIn.func_70651_bq()) {
+         final EffectInstance mobEffect = (EffectInstance)o1;
+         playerIn.field_71135_a.func_147359_a(new SPlayEntityEffectPacket(playerIn.func_145782_y(), mobEffect));
+      }
+
+      // Fire advancement trigger
+      playerIn.func_213846_b(((CraftWorld)fromWorld).getHandle());
+
+      // Don't fire on respawn
+      if (fromWorld != location.getWorld()) {
+         PlayerChangedWorldEvent event = new PlayerChangedWorldEvent(playerIn.getBukkitEntity(), fromWorld);
+         this.field_72400_f.server.getPluginManager().callEvent(event);
+      }
+
+      // Save player file again if they were disconnected
+      if (playerIn.field_71135_a.isDisconnected()) {
+         this.func_72391_b(playerIn);
+      }
+      // CraftBukkit end
+      net.minecraftforge.fml.hooks.BasicEventHooks.firePlayerRespawnEvent(serverPlayerEntity, conqueredEnd);
+      return serverPlayerEntity;
    }
 
    public void func_187243_f(ServerPlayerEntity p_187243_1_) {
@@ -431,21 +665,45 @@
 
    public void func_72374_b() {
       if (++this.field_72408_o > 600) {
-         this.func_148540_a(new SPlayerListItemPacket(SPlayerListItemPacket.Action.UPDATE_LATENCY, this.field_72404_b));
+         // CraftBukkit start
+         for (int i = 0; i < this.field_72404_b.size(); i++) {
+            ServerPlayerEntity target = this.field_72404_b.get(i);
+            target.field_71135_a.func_147359_a(new SPlayerListItemPacket(Action.UPDATE_LATENCY,
+                this.field_72404_b.stream().filter(serverPlayerEntity -> target.getBukkitEntity().canSee(serverPlayerEntity.getBukkitEntity())).collect(Collectors.toList())));
+         }
+         // CraftBukkit end
          this.field_72408_o = 0;
       }
 
    }
 
    public void func_148540_a(IPacket<?> p_148540_1_) {
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          (this.field_72404_b.get(i)).field_71135_a.func_147359_a(p_148540_1_);
       }
 
    }
 
+   // CraftBukkit start - add a world/entity limited version
+   public void sendAll(IPacket packetIn, PlayerEntity entityhuman) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
+         ServerPlayerEntity entityplayer = this.field_72404_b.get(i);
+         if (entityhuman != null && entityhuman instanceof ServerPlayerEntity && !entityplayer.getBukkitEntity().canSee(((ServerPlayerEntity)entityhuman).getBukkitEntity())) {
+            continue;
+         }
+         ((ServerPlayerEntity) this.field_72404_b.get(i)).field_71135_a.func_147359_a(packetIn);
+      }
+   }
+
+   public void sendAll(IPacket packetIn, net.minecraft.world.World world) {
+      for (int i = 0; i < world.func_217369_A().size(); ++i) {
+         ((ServerPlayerEntity) world.func_217369_A().get(i)).field_71135_a.func_147359_a(packetIn);
+      }
+   }
+   // CraftBukkit end
+
    public void func_148537_a(IPacket<?> p_148537_1_, DimensionType p_148537_2_) {
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          ServerPlayerEntity serverplayerentity = this.field_72404_b.get(i);
          if (serverplayerentity.field_71093_bK == p_148537_2_) {
             serverplayerentity.field_71135_a.func_147359_a(p_148537_1_);
@@ -457,7 +715,7 @@
    public void func_177453_a(PlayerEntity p_177453_1_, ITextComponent p_177453_2_) {
       Team team = p_177453_1_.func_96124_cp();
       if (team != null) {
-         for(String s : team.func_96670_d()) {
+         for (String s : team.func_96670_d()) {
             ServerPlayerEntity serverplayerentity = this.func_152612_a(s);
             if (serverplayerentity != null && serverplayerentity != p_177453_1_) {
                serverplayerentity.func_145747_a(p_177453_2_);
@@ -472,7 +730,7 @@
       if (team == null) {
          this.func_148539_a(p_177452_2_);
       } else {
-         for(int i = 0; i < this.field_72404_b.size(); ++i) {
+         for (int i = 0; i < this.field_72404_b.size(); ++i) {
             ServerPlayerEntity serverplayerentity = this.field_72404_b.get(i);
             if (serverplayerentity.func_96124_cp() != team) {
                serverplayerentity.func_145747_a(p_177452_2_);
@@ -485,7 +743,7 @@
    public String[] func_72369_d() {
       String[] astring = new String[this.field_72404_b.size()];
 
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          astring[i] = this.field_72404_b.get(i).func_146103_bH().getName();
       }
 
@@ -526,12 +784,13 @@
          } else if (p_187245_2_ >= 4) {
             b0 = 28;
          } else {
-            b0 = (byte)(24 + p_187245_2_);
+            b0 = (byte) (24 + p_187245_2_);
          }
 
          p_187245_1_.field_71135_a.func_147359_a(new SEntityStatusPacket(p_187245_1_, b0));
       }
 
+      p_187245_1_.getBukkitEntity().recalculatePermissions(); // CraftBukkit
       this.field_72400_f.func_195571_aL().func_197051_a(p_187245_1_);
    }
 
@@ -545,18 +804,19 @@
 
    @Nullable
    public ServerPlayerEntity func_152612_a(String p_152612_1_) {
-      for(ServerPlayerEntity serverplayerentity : this.field_72404_b) {
-         if (serverplayerentity.func_146103_bH().getName().equalsIgnoreCase(p_152612_1_)) {
-            return serverplayerentity;
-         }
-      }
-
-      return null;
+      return this.playersByName.get(p_152612_1_.toLowerCase(java.util.Locale.ROOT)); // Spigot
    }
 
    public void func_148543_a(@Nullable PlayerEntity p_148543_1_, double p_148543_2_, double p_148543_4_, double p_148543_6_, double p_148543_8_, DimensionType p_148543_10_, IPacket<?> p_148543_11_) {
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          ServerPlayerEntity serverplayerentity = this.field_72404_b.get(i);
+
+         // CraftBukkit start - Test if player receiving packet can see the source of the packet
+         if (p_148543_1_ != null && p_148543_1_ instanceof ServerPlayerEntity && !serverplayerentity.getBukkitEntity().canSee(((ServerPlayerEntity) p_148543_1_).getBukkitEntity())) {
+            continue;
+         }
+         // CraftBukkit end
+
          if (serverplayerentity != p_148543_1_ && serverplayerentity.field_71093_bK == p_148543_10_) {
             double d0 = p_148543_2_ - serverplayerentity.func_226277_ct_();
             double d1 = p_148543_4_ - serverplayerentity.func_226278_cu_();
@@ -570,7 +830,7 @@
    }
 
    public void func_72389_g() {
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
+      for (int i = 0; i < this.field_72404_b.size(); ++i) {
          this.func_72391_b(this.field_72404_b.get(i));
       }
 
@@ -596,23 +856,33 @@
    }
 
    public void func_72354_b(ServerPlayerEntity p_72354_1_, ServerWorld p_72354_2_) {
-      WorldBorder worldborder = this.field_72400_f.func_71218_a(DimensionType.field_223227_a_).func_175723_af();
+      WorldBorder worldborder = p_72354_1_.field_70170_p.func_175723_af(); // CraftBukkit
       p_72354_1_.field_71135_a.func_147359_a(new SWorldBorderPacket(worldborder, SWorldBorderPacket.Action.INITIALIZE));
       p_72354_1_.field_71135_a.func_147359_a(new SUpdateTimePacket(p_72354_2_.func_82737_E(), p_72354_2_.func_72820_D(), p_72354_2_.func_82736_K().func_223586_b(GameRules.field_223607_j)));
       BlockPos blockpos = p_72354_2_.func_175694_M();
       p_72354_1_.field_71135_a.func_147359_a(new SSpawnPositionPacket(blockpos));
       if (p_72354_2_.func_72896_J()) {
+         // CraftBukkit start - handle player weather
          p_72354_1_.field_71135_a.func_147359_a(new SChangeGameStatePacket(1, 0.0F));
          p_72354_1_.field_71135_a.func_147359_a(new SChangeGameStatePacket(7, p_72354_2_.func_72867_j(1.0F)));
          p_72354_1_.field_71135_a.func_147359_a(new SChangeGameStatePacket(8, p_72354_2_.func_72819_i(1.0F)));
+         p_72354_1_.setPlayerWeather(org.bukkit.WeatherType.DOWNFALL, false);
+         p_72354_1_.updateWeather(-p_72354_2_.field_73004_o, p_72354_2_.field_73004_o, -p_72354_2_.field_73017_q, p_72354_2_.field_73017_q);
+         // CraftBukkit end
       }
 
    }
 
    public void func_72385_f(ServerPlayerEntity p_72385_1_) {
       p_72385_1_.func_71120_a(p_72385_1_.field_71069_bz);
-      p_72385_1_.func_71118_n();
+      p_72385_1_.getBukkitEntity().updateScaledHealth(); // CraftBukkit - Update scaled health on respawn and worldchange
       p_72385_1_.field_71135_a.func_147359_a(new SHeldItemChangePacket(p_72385_1_.field_71071_by.field_70461_c));
+      // CraftBukkit start - from GameRules
+      int i = p_72385_1_.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223612_o) ? 22 : 23;
+      p_72385_1_.field_71135_a.func_147359_a(new SEntityStatusPacket(p_72385_1_, (byte)i));
+      float immediateRespawn = p_72385_1_.field_70170_p.func_82736_K().func_223586_b(GameRules.field_226683_z_) ? 1.0f : 0.0f;
+      p_72385_1_.field_71135_a.func_147359_a(new SChangeGameStatePacket(11, immediateRespawn));
+      // CraftBukkit end
    }
 
    public int func_72394_k() {
@@ -634,7 +904,7 @@
    public List<ServerPlayerEntity> func_72382_j(String p_72382_1_) {
       List<ServerPlayerEntity> list = Lists.newArrayList();
 
-      for(ServerPlayerEntity serverplayerentity : this.field_72404_b) {
+      for (ServerPlayerEntity serverplayerentity : this.field_72404_b) {
          if (serverplayerentity.func_71114_r().equals(p_72382_1_)) {
             list.add(serverplayerentity);
          }
@@ -676,37 +946,51 @@
    }
 
    public void func_72392_r() {
-      for(int i = 0; i < this.field_72404_b.size(); ++i) {
-         (this.field_72404_b.get(i)).field_71135_a.func_194028_b(new TranslationTextComponent("multiplayer.disconnect.server_shutdown"));
-      }
-
+      // CraftBukkit start - disconnect safely
+      field_72404_b.forEach(player -> player.field_71135_a.disconnect(this.field_72400_f.server.getShutdownMessage())); // CraftBukkit start - disconnect safely
+      // CraftBukkit end
    }
 
    public void func_148544_a(ITextComponent p_148544_1_, boolean p_148544_2_) {
       this.field_72400_f.func_145747_a(p_148544_1_);
       ChatType chattype = p_148544_2_ ? ChatType.SYSTEM : ChatType.CHAT;
-      this.func_148540_a(new SChatPacket(p_148544_1_, chattype));
+      // CraftBukkit start - we run this through our processor first so we can get web links etc
+      this.func_148540_a(new SChatPacket(CraftChatMessage.fixComponent(p_148544_1_), chattype));
+      // CraftBukkit end
    }
 
+   // CraftBukkit start
+   public void sendMessage(ITextComponent[] components) {
+      Arrays.stream(components).forEach(component -> func_148544_a(component, true));
+   }
+   // CraftBukkit end
+
    public void func_148539_a(ITextComponent p_148539_1_) {
       this.func_148544_a(p_148539_1_, true);
    }
 
-   public ServerStatisticsManager func_152602_a(PlayerEntity p_152602_1_) {
-      UUID uuid = p_152602_1_.func_110124_au();
-      ServerStatisticsManager serverstatisticsmanager = uuid == null ? null : this.field_148547_k.get(uuid);
+   //CraftBukkit start
+   public ServerStatisticsManager getPlayerStats(ServerPlayerEntity playerIn) {
+      ServerStatisticsManager serverStatisticsManager = playerIn.func_147099_x();
+      return (serverStatisticsManager == null) ? this.getStatisticManager(playerIn.func_110124_au(), playerIn.func_200200_C_().toString()) : serverStatisticsManager;
+   }
+   // CraftBukkit end
+
+   public ServerStatisticsManager getStatisticManager(UUID uuid, String displayName) {
+      ServerPlayerEntity player = func_177451_a(uuid);
+      ServerStatisticsManager serverstatisticsmanager = player == null ? null : player.func_147099_x();
       if (serverstatisticsmanager == null) {
          File file1 = new File(this.field_72400_f.func_71218_a(DimensionType.field_223227_a_).func_217485_w().func_75765_b(), "stats");
          File file2 = new File(file1, uuid + ".json");
          if (!file2.exists()) {
-            File file3 = new File(file1, p_152602_1_.func_200200_C_().getString() + ".json");
+            File file3 = new File(file1, displayName + ".json"); // CraftBukkit
             if (file3.exists() && file3.isFile()) {
                file3.renameTo(file2);
             }
          }
 
          serverstatisticsmanager = new ServerStatisticsManager(this.field_72400_f, file2);
-         this.field_148547_k.put(uuid, serverstatisticsmanager);
+         //this.playerStatFiles.put(uuid, serverstatisticsmanager); // CraftBukkit
       }
 
       return serverstatisticsmanager;
@@ -714,12 +998,12 @@
 
    public PlayerAdvancements func_192054_h(ServerPlayerEntity p_192054_1_) {
       UUID uuid = p_192054_1_.func_110124_au();
-      PlayerAdvancements playeradvancements = this.field_192055_p.get(uuid);
+      PlayerAdvancements playeradvancements = p_192054_1_.func_192039_O(); // CraftBukkit
       if (playeradvancements == null) {
          File file1 = new File(this.field_72400_f.func_71218_a(DimensionType.field_223227_a_).func_217485_w().func_75765_b(), "advancements");
          File file2 = new File(file1, uuid + ".json");
          playeradvancements = new PlayerAdvancements(this.field_72400_f, file2, p_192054_1_);
-         this.field_192055_p.put(uuid, playeradvancements);
+         // this.advancements.put(uuid, playeradvancements); // CraftBukkit
       }
 
       playeradvancements.func_192739_a(p_192054_1_);
@@ -730,7 +1014,7 @@
       this.field_72402_d = p_217884_1_;
       this.func_148540_a(new SUpdateViewDistancePacket(p_217884_1_));
 
-      for(ServerWorld serverworld : this.field_72400_f.func_212370_w()) {
+      for (ServerWorld serverworld : this.field_72400_f.func_212370_w()) {
          if (serverworld != null) {
             serverworld.func_72863_F().func_217219_a(p_217884_1_);
          }
@@ -739,7 +1023,7 @@
    }
 
    public List<ServerPlayerEntity> func_181057_v() {
-      return this.field_72404_b;
+      return this.playersView; //Unmodifiable view, we don't want people removing things without us knowing.
    }
 
    @Nullable
@@ -752,16 +1036,17 @@
    }
 
    public void func_193244_w() {
-      for(PlayerAdvancements playeradvancements : this.field_192055_p.values()) {
-         playeradvancements.func_193766_b();
+      for (ServerPlayerEntity player : this.field_72404_b) {
+         player.func_192039_O().func_193766_b();
+         player.func_192039_O().func_192741_b(player);
       }
 
       this.func_148540_a(new STagsListPacket(this.field_72400_f.func_199731_aO()));
       SUpdateRecipesPacket supdaterecipespacket = new SUpdateRecipesPacket(this.field_72400_f.func_199529_aN().func_199510_b());
 
-      for(ServerPlayerEntity serverplayerentity : this.field_72404_b) {
+      for (ServerPlayerEntity serverplayerentity : this.field_72404_b) {
          serverplayerentity.field_71135_a.func_147359_a(supdaterecipespacket);
-         serverplayerentity.func_192037_E().func_192826_c(serverplayerentity);
+         serverplayerentity.func_192037_E().func_192826_c(serverplayerentity); //CraftBukkit - trigger immediate flush of advancements
       }
 
    }
@@ -769,4 +1054,14 @@
    public boolean func_206257_x() {
       return this.field_72407_n;
    }
+
+   public boolean addPlayer(ServerPlayerEntity player) {
+      this.playersByName.put(player.func_145748_c_().func_150254_d().toLowerCase(java.util.Locale.ROOT), player); // Spigot
+      return net.minecraftforge.common.DimensionManager.rebuildPlayerMap(this, this.field_72404_b.add(player));
+   }
+
+   public boolean removePlayer(ServerPlayerEntity player) {
+      this.playersByName.remove(player.func_145748_c_().func_150254_d().toLowerCase(java.util.Locale.ROOT)); // Spigot
+      return net.minecraftforge.common.DimensionManager.rebuildPlayerMap(this, this.field_72404_b.remove(player));
+   }
 }
