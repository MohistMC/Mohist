--- a/net/minecraft/server/network/LoginListener.java
+++ b/net/minecraft/server/network/LoginListener.java
#!!!!!!!!!!!!!
# Playerlist need a patch to work with this
#!!!!!!!!!!!!!
@@ -101,10 +123,12 @@
             this.gameProfile = this.createFakeProfile(this.gameProfile);
         }
 
-        IChatBaseComponent ichatbasecomponent = this.server.getPlayerList().canPlayerLogin(this.connection.getRemoteAddress(), this.gameProfile);
+        // CraftBukkit start - fire PlayerLoginEvent
+        EntityPlayer s = this.server.getPlayerList().canPlayerLogin(this, this.gameProfile, hostname);
 
-        if (ichatbasecomponent != null) {
-            this.disconnect(ichatbasecomponent);
+        if (s == null) {
+            // this.disconnect(ichatbasecomponent);
+            // CraftBukkit end
         } else {
             this.state = LoginListener.EnumProtocolState.ACCEPTED;
             if (this.server.getCompressionThreshold() >= 0 && !this.connection.isMemoryConnection()) {
@@ -117,7 +141,7 @@
             EntityPlayer entityplayer = this.server.getPlayerList().getPlayer(this.gameProfile.getId());
 
             try {
-                EntityPlayer entityplayer1 = this.server.getPlayerList().getPlayerForLogin(this.gameProfile);
+                EntityPlayer entityplayer1 = this.server.getPlayerList().getPlayerForLogin(this.gameProfile, s); // CraftBukkit - add player reference
 
                 if (entityplayer != null) {
                     this.state = LoginListener.EnumProtocolState.DELAY_ACCEPT;

